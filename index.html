<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integritas File Pro // Security & Gaming Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. CONFIG & RESET --- */
        :root {
            --primary: #6366f1;   /* Indigo */
            --secondary: #d946ef; /* Fuchsia */
            --bg-dark: #0f172a;   /* Slate 900 */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #22c55e;
            --coolrom: #3b82f6;   /* Blue for CoolROM */
            --youtube: #ef4444;   /* Red for YouTube */
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            margin: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            flex-direction: column;
        }

        /* --- 2. ANIMATED BACKGROUND --- */
        .bg-animate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at center, #1e293b 0%, #000000 100%);
            overflow: hidden;
        }
        .blob {
            position: absolute; border-radius: 50%;
            filter: blur(80px); opacity: 0.5;
            animation: float 20s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 600px; height: 600px; background: var(--primary); animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: var(--secondary); animation-delay: -5s; }
        
        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, -50px) scale(1.1); }
        }

        /* --- 3. MAIN CARD (GLASSMORPHISM) --- */
        .app-container {
            position: relative;
            width: 90%; max-width: 520px;
            background: var(--glass-bg);
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: fadeIn 0.8s ease-out;
            transition: height 0.3s ease;
            margin: 20px 0;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER */
        .header h1 {
            font-size: 1.8rem; font-weight: 800; margin: 10px 0 5px;
            background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header i.logo {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stats-badge {
            display: inline-block; background: rgba(255,255,255,0.08);
            padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; color: var(--text-muted);
            margin-top: 5px; border: 1px solid rgba(255,255,255,0.05);
        }

        /* TOP RIGHT BUTTONS (GEAR & TOOLS) */
        .top-actions {
            position: absolute; top: 20px; right: 20px;
            display: flex; gap: 15px; z-index: 10;
        }
        .btn-icon {
            color: var(--text-muted); cursor: pointer; font-size: 1.2rem;
            transition: 0.3s; background: transparent; border: none; padding: 5px;
        }
        .btn-icon:hover { color: #fff; transform: scale(1.1); }
        .btn-icon.active { color: var(--primary); }

        /* PANELS (SETTINGS & TOOLS) */
        .side-panel {
            display: none; text-align: left;
            background: rgba(15, 23, 42, 0.98); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;
            animation: slideDown 0.3s ease-out;
            position: absolute; width: 100%; left: 0; top: 0; z-index: 20; height: 100%;
            overflow-y: auto; 
        }
        .side-panel.active { display: block; }
        
        .panel-close { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #fff; transition:0.2s; font-size: 1.2rem;}
        .panel-close:hover { color: var(--primary); transform: rotate(90deg); }
        
        .panel-header { margin: 0 0 20px 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }

        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }
        .input-field {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            padding: 10px; border-radius: 8px; color: #fff; font-family: monospace; font-size: 0.85rem;
        }
        .input-field:focus { border-color: var(--primary); }

        /* TOGGLE SWITCH STYLE */
        .toggle-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 15px;
            border: 1px solid var(--glass-border);
        }
        .toggle-label { font-size: 0.85rem; color: #fff; font-weight: 600; }
        .toggle-desc { font-size: 0.7rem; color: var(--text-muted); margin: 0; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #475569; transition: .4s; border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        .panel-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .btn-xs {
            flex: 1; padding: 12px 10px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 0.8rem; font-weight: 600; color: #fff; background: rgba(255,255,255,0.1);
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-xs:hover { background: rgba(255,255,255,0.2); }
        .btn-xs.danger:hover { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .btn-xs.success:hover { background: rgba(34, 197, 94, 0.3); color: #86efac; }

        /* UPLOAD ZONE */
        .upload-area {
            margin-top: 2rem; border: 2px dashed rgba(255,255,255,0.15);
            border-radius: 16px; padding: 2.5rem 1.5rem; cursor: pointer;
            background: rgba(0,0,0,0.2); transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary); background: rgba(99, 102, 241, 0.1); transform: scale(1.01);
        }
        .upload-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; transition: 0.3s; }
        .upload-text h3 { margin: 0; font-size: 1.1rem; font-weight: 600; }
        .upload-text p { margin: 5px 0 0; font-size: 0.85rem; color: var(--text-muted); }

        /* PROGRESS BAR */
        .progress-container {
            height: 4px; width: 100%; background: rgba(255,255,255,0.1);
            margin-top: 20px; border-radius: 2px; overflow: hidden; display: none;
        }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

        /* MAIN ACTION BUTTON */
        .btn-main {
            width: 100%; margin-top: 1.5rem; padding: 1rem; border: none; border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: 0.3s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5); }
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* RESULT AREA */
        .result-box {
            display: none; margin-top: 2rem; text-align: left;
            border-top: 1px solid var(--glass-border); padding-top: 1.5rem;
            animation: slideUp 0.4s ease-out;
        }
        
        /* Status Badges */
        .badge { padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 10px; }
        .badge.success { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge.warning { background: rgba(234, 179, 8, 0.15); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
        
        .result-title { margin: 0 0 5px 0; font-size: 1.1rem; color: #fff; }
        .result-desc { margin: 0 0 15px 0; font-size: 0.85rem; color: var(--text-muted); }

        /* Hash Display */
        .hash-display {
            background: rgba(0,0,0,0.4); padding: 12px; border-radius: 8px;
            font-family: 'Courier New', monospace; font-size: 0.8rem; color: #cbd5e1;
            word-break: break-all; cursor: pointer; position: relative;
            border: 1px solid var(--glass-border); transition: 0.2s;
        }
        .hash-display:hover { border-color: var(--primary); color: #fff; }
        .hash-display:active { transform: scale(0.98); }
        .hash-display::after {
            content: "Disalin!"; position: absolute; top: -25px; right: 0;
            background: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;
            opacity: 0; transition: 0.2s; pointer-events: none;
        }
        .hash-display.copied::after { opacity: 1; top: -30px; }

        /* ADD TO DB FORM */
        .add-db-box {
            margin-top: 15px; background: rgba(250, 204, 21, 0.05);
            border: 1px dashed rgba(250, 204, 21, 0.3); border-radius: 12px; padding: 15px;
        }
        .add-db-title { font-size: 0.85rem; color: #facc15; font-weight: 700; margin-bottom: 10px; }
        .btn-add {
            background: #facc15; color: #000; border: none; padding: 8px 16px;
            border-radius: 6px; font-size: 0.8rem; font-weight: 700; cursor: pointer; margin-top: 8px;
        }

        /* EXTERNAL BUTTONS */
        .btn-external {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 12px; border-radius: 12px; border: none; margin-top: 10px;
            color: white; font-weight: 600; text-decoration: none; cursor: pointer;
            transition: 0.3s; font-size: 0.85rem;
        }
        .btn-external:hover { transform: translateY(-2px); }
        
        .vt-bg { background: #2563eb; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2); }
        .vt-bg:hover { background: #1d4ed8; }

        .cr-bg { background: #0891b2; box-shadow: 0 4px 15px rgba(8, 145, 178, 0.2); }
        .cr-bg:hover { background: #0e7490; }

        .grid-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }

        /* KEBAB MENU (DROPDOWN) */
        .kebab-container { position: relative; }
        .btn-kebab {
            background: transparent; border: none; color: var(--text-muted);
            font-size: 1.2rem; cursor: pointer; padding: 5px 10px; border-radius: 50%;
            transition: 0.2s;
        }
        .btn-kebab:hover { background: rgba(255,255,255,0.1); color: #fff; }
        
        .dropdown-menu {
            display: none; position: absolute; right: 0; top: 35px;
            background: #1e293b; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; min-width: 220px; z-index: 50;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden;
            animation: fadeScale 0.2s ease-out;
        }
        .dropdown-menu.show { display: block; }
        
        .dropdown-item {
            display: flex; align-items: center; width: 100%; padding: 12px 15px;
            color: #e2e8f0; text-decoration: none; font-size: 0.85rem;
            background: transparent; border: none; cursor: pointer;
            text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .dropdown-item:hover { background: rgba(99, 102, 241, 0.1); color: #fff; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item i { margin-right: 10px; width: 16px; text-align: center; color: var(--text-muted); }
        .dropdown-item:hover i { color: var(--primary); }

        @keyframes fadeScale {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SECTION HEADERS */
        .section-header {
            margin: 25px 0 15px 0; font-size: 0.85rem; color: var(--text-muted);
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;
            display: flex; align-items: center; gap: 8px;
        }
        .section-header i { color: #fff; }

        /* --- YOUTUBE PREVIEW --- */
        .yt-preview {
            display: none; margin-top: 10px; background: rgba(0,0,0,0.3);
            border-radius: 10px; overflow: hidden; padding: 10px; border: 1px solid var(--glass-border);
        }
        .yt-preview img { width: 100%; border-radius: 8px; margin-bottom: 8px; aspect-ratio: 16/9; object-fit: cover; }
        .yt-title-badge { font-size: 0.7rem; background: var(--youtube); color: #fff; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .yt-status { font-size: 0.8rem; color: #fff; }
    </style>
</head>
<body>

    <div class="bg-animate">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div class="app-container">
        <!-- Top Buttons -->
        <div class="top-actions">
            <button class="btn-icon" onclick="togglePanel('toolsPanel')" title="Tools & Search"><i class="fa-solid fa-toolbox"></i></button>
            <button class="btn-icon" onclick="togglePanel('settingsPanel')" title="Pengaturan"><i class="fa-solid fa-gear"></i></button>
        </div>

        <!-- TOOLS PANEL -->
        <div class="side-panel" id="toolsPanel">
            <i class="fa-solid fa-xmark panel-close" onclick="togglePanel('toolsPanel')"></i>
            <h3 class="panel-header"><i class="fa-solid fa-toolbox"></i> Tools & Pencarian</h3>

            <!-- YOUTUBE SECTION -->
            <div style="color: var(--youtube); margin-bottom: 10px; font-weight: 600; font-size: 0.9rem;">
                <i class="fa-brands fa-youtube"></i> YouTube Tools
            </div>
            <div class="input-group">
                <input type="text" id="ytInput" class="input-field" placeholder="Paste Link YouTube / Judul Lagu..." oninput="detectYoutube(this.value)">
            </div>

            <!-- THUMBNAIL PREVIEW AREA -->
            <div class="yt-preview" id="ytPreview">
                <div class="yt-title-badge"><i class="fa-brands fa-youtube"></i> Video Detected</div>
                <img id="ytThumb" src="" alt="Thumbnail">
                <div class="yt-status" id="ytStatus">Siap untuk didownload</div>
            </div>

            <div class="panel-actions" id="ytButtons">
                <!-- Default Button -->
                <button class="btn-xs" style="background:rgba(239, 68, 68, 0.2); color:#fca5a5;" onclick="openYtTool('search')">
                    <i class="fa-solid fa-magnifying-glass"></i> Cari di YouTube
                </button>
            </div>

            <!-- COOLROM SECTION -->
            <div style="color: var(--coolrom); margin-top: 30px; margin-bottom: 10px; font-weight: 600; font-size: 0.9rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <i class="fa-solid fa-gamepad"></i> Game & Emulator
            </div>
            <div class="input-group">
                <input type="text" id="manualSearchInput" class="input-field" placeholder="Nama Game / Konsol (misal: PS2)...">
            </div>
            <div class="panel-actions">
                <button class="btn-xs" style="background:rgba(59, 130, 246, 0.2); color:#93c5fd;" onclick="manualSearch('game')">
                    <i class="fa-solid fa-search"></i> Cari Game
                </button>
                <button class="btn-xs" style="background:rgba(255,255,255,0.1);" onclick="manualSearch('emulator')">
                    <i class="fa-solid fa-microchip"></i> Cari Emulator
                </button>
            </div>
        </div>

        <!-- SETTINGS PANEL -->
        <div class="side-panel" id="settingsPanel">
            <i class="fa-solid fa-xmark panel-close" onclick="togglePanel('settingsPanel')"></i>
            <h3 class="panel-header"><i class="fa-solid fa-sliders"></i> Pengaturan</h3>
            
            <!-- AUTO SAVE TOGGLE -->
            <div class="toggle-wrapper">
                <div>
                    <div class="toggle-label">Auto-Simpan File Baru</div>
                    <p class="toggle-desc">Otomatis tambahkan file tak dikenal ke DB Lokal</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="autoSaveToggle" onchange="saveAutoSavePref()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- DB SETTINGS -->
            <div class="section-header"><i class="fa-brands fa-github"></i> Database Eksternal</div>
            <div class="input-group">
                <input type="text" id="githubUrl" class="input-field" placeholder="https://raw.githubusercontent.com/user/repo/main/db.json">
            </div>

            <div class="panel-actions">
                <button class="btn-xs" onclick="loadGithubDB()"><i class="fa-solid fa-rotate"></i> Update</button>
                <button class="btn-xs success" onclick="exportLocalDB()"><i class="fa-solid fa-download"></i> Backup</button>
                <button class="btn-xs danger" onclick="clearLocalDB()"><i class="fa-solid fa-trash"></i> Reset</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <i class="fa-solid fa-shield-halved logo"></i>
            <h1>Integritas File Pro</h1>
            <div class="stats-badge" id="dbStats">Memuat Database...</div>
        </div>

        <!-- Upload Zone -->
        <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" hidden onchange="handleFile(this.files[0])">
            <div class="upload-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
            <div class="upload-text" id="uploadText">
                <h3>Klik atau Drag File</h3>
                <p>Mendukung EXE, ZIP, ISO, dll.</p>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-container" id="loader">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- Action Button -->
        <button class="btn-main" id="scanBtn" onclick="processScan()" disabled>Pilih File Dahulu</button>

        <!-- Result Section -->
        <div class="result-box" id="resultArea"></div>
    </div>

    <script>
        /* --- JAVASCRIPT LOGIC --- */

        const DEFAULT_DB = {
            "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855": "File Kosong (Test)",
            "bc9c8755865254e7644430716767446727120423630664566700254127672521": "WinRAR 6.11 x64 (Official)",
            "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824": "File Teks 'hello' (Sample)"
        };

        // Daftar Ekstensi Game
        const GAME_EXTENSIONS = ['iso', 'cso', 'bin', 'img', 'rom', 'nds', 'gba', 'nes', 'sfc', 'n64', 'z64', 'v64', 'gcm', 'wbfs', 'cue', 'mds', 'pbp'];

        let combinedDB = {};
        let currentFile = null;
        let currentHash = null;
        let currentYtId = null;

        const els = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            uploadText: document.getElementById('uploadText'),
            scanBtn: document.getElementById('scanBtn'),
            loader: document.getElementById('loader'),
            progressBar: document.getElementById('progressBar'),
            resultArea: document.getElementById('resultArea'),
            dbStats: document.getElementById('dbStats'),
            githubUrl: document.getElementById('githubUrl'),
            autoSaveToggle: document.getElementById('autoSaveToggle'),
            ytPreview: document.getElementById('ytPreview'),
            ytThumb: document.getElementById('ytThumb'),
            ytButtons: document.getElementById('ytButtons')
        };

        window.onload = () => {
            const savedUrl = localStorage.getItem('integrity_github_url');
            if (savedUrl) els.githubUrl.value = savedUrl;

            const autoSavePref = localStorage.getItem('integrity_autosave_mode') === 'true';
            els.autoSaveToggle.checked = autoSavePref;

            initDragDrop();
            refreshDatabase();
        };

        // Close dropdown when clicking outside
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.kebab-container')) {
                const dropdowns = document.querySelectorAll('.dropdown-menu');
                dropdowns.forEach(d => d.classList.remove('show'));
            }
        });

        function toggleDropdown(id) {
            const menu = document.getElementById(id);
            document.querySelectorAll('.dropdown-menu').forEach(d => {
                if (d.id !== id) d.classList.remove('show');
            });
            menu.classList.toggle('show');
        }

        // Generic Panel Toggler
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const allPanels = document.querySelectorAll('.side-panel');
            
            // Close others first
            allPanels.forEach(p => {
                if(p.id !== panelId) p.classList.remove('active');
            });

            panel.classList.toggle('active');
        }

        function saveAutoSavePref() {
            localStorage.setItem('integrity_autosave_mode', els.autoSaveToggle.checked);
        }

        // --- YOUTUBE LOGIC (IMPROVED) ---
        function detectYoutube(val) {
            val = val.trim();
            els.ytPreview.style.display = 'none';
            currentYtId = null;

            // Regex untuk ID Youtube (mendukung short, watch?v=, youtu.be)
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = val.match(regExp);

            if (match && match[2].length == 11) {
                // VIDEO DETECTED
                currentYtId = match[2];
                els.ytThumb.src = `https://img.youtube.com/vi/${currentYtId}/mqdefault.jpg`;
                els.ytPreview.style.display = 'block';
                
                // Show Direct Actions
                els.ytButtons.innerHTML = `
                    <button class="btn-xs" style="background:#ff0000;" onclick="openService('youtube')">
                        <i class="fa-brands fa-youtube"></i> Tonton
                    </button>
                    <button class="btn-xs" style="background:#2563eb;" onclick="openService('y2mate')">
                        <i class="fa-solid fa-file-audio"></i> MP3 (Y2Mate)
                    </button>
                     <button class="btn-xs" style="background:#16a34a;" onclick="openService('savefrom')">
                        <i class="fa-solid fa-video"></i> MP4 (SaveFrom)
                    </button>
                `;
            } else {
                // TEXT SEARCH
                els.ytButtons.innerHTML = `
                    <button class="btn-xs" style="background:rgba(239, 68, 68, 0.2); color:#fca5a5;" onclick="openYtTool('search')">
                        <i class="fa-solid fa-magnifying-glass"></i> Cari di YouTube
                    </button>
                `;
            }
        }

        function openService(service) {
            if (service === 'youtube') {
                window.open(`https://www.youtube.com/watch?v=${currentYtId}`, '_blank');
            } else if (service === 'y2mate') {
                window.open(`https://www.y2mate.com/youtube/${currentYtId}`, '_blank');
            } else if (service === 'savefrom') {
                window.open(`https://en.savefrom.net/1-youtube-video-downloader-4/`, '_blank'); 
                // Savefrom usually requires pasting the link manually now due to API changes, but direct URL tricks exist:
                // window.open(`https://ssyoutube.com/watch?v=${currentYtId}`, '_blank'); // Shortlink trick
            }
        }

        function openYtTool(action) {
            const val = document.getElementById('ytInput').value.trim();
            if (!val) return alert("Masukkan judul lagu terlebih dahulu!");
            window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(val)}`, '_blank');
        }

        // --- MANUAL SEARCH LOGIC ---
        function manualSearch(type) {
            const q = document.getElementById('manualSearchInput').value.trim();
            if(!q) return alert("Mohon isi kata kunci pencarian terlebih dahulu!");
            
            let suffix = type === 'emulator' ? ' emulator' : '';
            window.open(`https://coolrom.com.au/search?q=${encodeURIComponent(q + suffix)}`, '_blank');
        }

        // --- DATABASE MANAGEMENT ---
        async function refreshDatabase() {
            const localDB = JSON.parse(localStorage.getItem('integrity_local_db') || '{}');
            let remoteDB = {};

            const url = els.githubUrl.value.trim();
            if (url) {
                els.dbStats.innerText = "Syncing...";
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        remoteDB = await response.json();
                        localStorage.setItem('integrity_github_url', url);
                    }
                } catch (e) { console.error("Fetch Error:", e); }
            }

            combinedDB = { ...DEFAULT_DB, ...remoteDB, ...localDB };
            const total = Object.keys(combinedDB).length;
            const localCount = Object.keys(localDB).length;
            els.dbStats.innerHTML = `<i class="fa-solid fa-database"></i> Total: ${total} (${localCount} Lokal)`;
        }

        async function loadGithubDB() {
            if(!els.githubUrl.value) return alert("Masukkan URL terlebih dahulu.");
            await refreshDatabase();
            alert("Sinkronisasi selesai!");
        }

        function addToLocalDB(customName = null, customHash = null, isAuto = false) {
            const name = customName || document.getElementById('newFileName')?.value.trim();
            const hash = customHash || currentHash;

            if (!name || !hash) return alert("Nama tidak boleh kosong.");

            const localDB = JSON.parse(localStorage.getItem('integrity_local_db') || '{}');
            const dbName = name + (isAuto ? " (Auto-Saved)" : " (User Verified)");
            localDB[hash] = dbName;
            
            localStorage.setItem('integrity_local_db', JSON.stringify(localDB));
            refreshDatabase();

            if (isAuto) {
                return dbName; 
            } else {
                displayResult(hash); 
                alert("Disimpan ke Database Lokal!");
            }
        }

        function clearLocalDB() {
            if(confirm("Hapus semua database lokal?")) {
                localStorage.removeItem('integrity_local_db');
                refreshDatabase();
                alert("Database lokal bersih.");
            }
        }

        function exportLocalDB() {
            const localDB = JSON.parse(localStorage.getItem('integrity_local_db') || '{}');
            if(Object.keys(localDB).length === 0) return alert("Database lokal kosong.");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localDB, null, 2));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "my_integrity_db.json";
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        // --- FILE HANDLING ---
        function initDragDrop() {
            const zone = els.dropZone;
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                zone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(e => zone.addEventListener(e, () => zone.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(e => zone.addEventListener(e, () => zone.classList.remove('dragover')));
            zone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        }

        function handleFile(file) {
            if (!file) return;
            currentFile = file;
            els.resultArea.style.display = 'none';
            els.loader.style.display = 'none';
            els.progressBar.style.width = '0%';
            
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            document.querySelector('.upload-icon').innerHTML = '<i class="fa-solid fa-file-circle-check"></i>';
            
            const ext = file.name.split('.').pop().toLowerCase();
            const isGame = GAME_EXTENSIONS.includes(ext);
            const icon = isGame ? '<i class="fa-solid fa-gamepad" style="color:#a855f7"></i> ' : '';

            els.uploadText.innerHTML = `<h3 style="color:#fff; word-break:break-all;">${icon}${file.name}</h3><p>${sizeMB} MB - Siap Scan</p>`;
            els.scanBtn.disabled = false;
            els.scanBtn.innerText = "Mulai Scan Integritas";
        }

        // --- HASHING ---
        async function processScan() {
            if (!currentFile) return;
            els.scanBtn.disabled = true;
            els.scanBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Menghitung Hash...';
            els.loader.style.display = 'block';
            els.resultArea.style.display = 'none';

            try {
                const hash = await calculateSHA256(currentFile);
                currentHash = hash;
                els.progressBar.style.width = '100%';
                
                setTimeout(() => {
                    displayResult(hash);
                    els.scanBtn.disabled = false;
                    els.scanBtn.innerText = "Scan Ulang File Ini";
                }, 500);
            } catch (err) {
                console.error(err);
                alert("Gagal membaca file.");
                els.scanBtn.disabled = false;
                els.scanBtn.innerText = "Coba Lagi";
            }
        }

        function calculateSHA256(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        els.progressBar.style.width = Math.round((e.loaded / e.total) * 90) + '%';
                    }
                };
                reader.onload = async (e) => {
                    try {
                        const buffer = await crypto.subtle.digest('SHA-256', e.target.result);
                        const hashHex = Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
                        resolve(hashHex);
                    } catch (err) { reject(err); }
                };
                reader.onerror = () => reject("Error");
                reader.readAsArrayBuffer(file);
            });
        }

        // --- DISPLAY RESULT ---
        function displayResult(hash) {
            els.resultArea.style.display = 'block';
            let match = combinedDB[hash];

            const isAutoSave = els.autoSaveToggle.checked;
            if (!match && isAutoSave) {
                match = addToLocalDB(currentFile.name, hash, true);
            }

            const ext = currentFile.name.split('.').pop().toLowerCase();
            const isGame = GAME_EXTENSIONS.includes(ext);
            const cleanName = currentFile.name.replace(/\.[^/.]+$/, "").replace(/[\[\(].*?[\]\)]/g, "").trim();

            let html = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div>
            `;

            if (match) {
                html += `<div class="badge success"><i class="fa-solid fa-check"></i> TERVERIFIKASI</div>`;
            } else {
                html += `<div class="badge warning"><i class="fa-solid fa-triangle-exclamation"></i> BELUM TERDAFTAR</div>`;
            }

            html += `
                    </div>
                    <div class="kebab-container">
                        <button class="btn-kebab" onclick="toggleDropdown('resultMenu')">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                        <div class="dropdown-menu" id="resultMenu">
                            <button class="dropdown-item" onclick="copyToClipboard(this, '${hash}')">
                                <i class="fa-regular fa-copy"></i> Salin Hash
                            </button>
                            <a href="https://www.virustotal.com/gui/file/${hash}" target="_blank" class="dropdown-item">
                                <i class="fa-solid fa-shield-virus"></i> Cek VirusTotal
                            </a>
            `;

            if (isGame) {
                html += `
                    <a href="https://coolrom.com.au/search?q=${encodeURIComponent(cleanName)}" target="_blank" class="dropdown-item">
                        <i class="fa-solid fa-magnifying-glass"></i> Cari di CoolROM
                    </a>
                    <a href="https://www.google.com/search?q=${hash}+site:redump.org" target="_blank" class="dropdown-item">
                        <i class="fa-solid fa-database"></i> Cek DB Redump
                    </a>
                `;
            }

            html += `
                        </div>
                    </div>
                </div>
            `;

            if (match) {
                html += `
                    <h2 class="result-title">${match}</h2>
                    <p class="result-desc">File ini aman dan terdaftar dalam database lokal/resmi.</p>
                `;
            } else {
                html += `
                    <h2 class="result-title">File Tidak Dikenal</h2>
                    <p class="result-desc">Hash tidak ditemukan. Simpan ke database lokal jika Anda yakin file ini aman.</p>

                    <div class="add-db-box">
                        <div class="add-db-title"><i class="fa-solid fa-plus-circle"></i> Tambah Manual?</div>
                        <input type="text" id="newFileName" class="input-field" 
                               placeholder="Nama File" value="${currentFile.name}">
                        <button class="btn-add" onclick="addToLocalDB()">Simpan Manual</button>
                    </div>
                `;
            }

            html += `
                <div style="margin-top: 20px;">
                    <label style="font-size:0.75rem; color:#94a3b8; display:block; margin-bottom:5px;">SHA-256 FINGERPRINT:</label>
                    <div class="hash-display" onclick="copyToClipboard(this, '${hash}')" title="Klik Salin">${hash}</div>
                </div>
            `;

            if (isGame) {
                 html += `
                    <div style="margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #facc15;"><i class="fa-solid fa-gamepad"></i> Game Detected</h4>
                        <div class="grid-btns">
                            <a href="https://coolrom.com.au/search?q=${encodeURIComponent(cleanName)}" target="_blank" class="btn-external cr-bg">
                                <i class="fa-solid fa-magnifying-glass"></i> CoolROM
                            </a>
                             <a href="https://www.google.com/search?q=${hash}+site:redump.org" target="_blank" class="btn-external" style="background: #be123c; box-shadow: 0 4px 15px rgba(190, 18, 60, 0.2);">
                                <i class="fa-solid fa-check-double"></i> Redump
                            </a>
                        </div>
                    </div>
                `;
            } else {
                 html += `
                    <div style="margin-top: 15px; padding-top: 5px;">
                        <a href="https://www.virustotal.com/gui/file/${hash}" target="_blank" class="btn-external vt-bg">
                            <i class="fa-solid fa-shield-virus"></i> Cek VirusTotal
                        </a>
                    </div>
                `;
            }
            
            els.resultArea.innerHTML = html;
        }

        function copyToClipboard(el, text) {
            navigator.clipboard.writeText(text).then(() => {
                el.classList.add('copied');
                setTimeout(() => el.classList.remove('copied'), 1500);
            });
        }

    </script>
</body>
</html>
